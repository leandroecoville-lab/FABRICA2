name: PRODUCAO_DE_FABRICA

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Escolha o que gerar"
        required: true
        default: "pack0"
        type: choice
        options:
          - pack0
          - pack1
      module:
        description: "Nome do modulo (ex: meetcore)"
        required: true
        default: "meetcore"
      trace:
        description: "Identificador"
        required: true
        default: "LAI-RUN"
      blueprint:
        description: "Blueprint (opcional)"
        required: false
        default: ""

jobs:
  gerar:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependencias corretas
        run: |
          python -m pip install --upgrade pip
          pip install -r services/pack-factory/requirements.txt

      - name: Preparar pastas
        run: |
          mkdir -p _inputs _outputs

      - name: Salvar blueprint (arquivo apenas)
        run: |
          echo "${{ inputs.blueprint }}" > _inputs/blueprint.txt

      - name: Rodar motor
        env:
          MODE: ${{ inputs.mode }}
          MODULE: ${{ inputs.module }}
          TRACE: ${{ inputs.trace }}
        run: |
          cd services/pack-factory
          export PYTHONPATH="$(pwd):$PYTHONPATH"

          echo "Executando $MODE para $MODULE"

          python -m app.cli "$MODE" --module "$MODULE" --out "../../_outputs" --trace "$TRACE"

          if [ "$MODE" = "pack0" ]; then
            echo "Validando Pack0"
            python -m app.cli validate-pack0 \
              --target "../../_outputs/pack0-${MODULE}-0.0.1.zip" \
              --out "../../_outputs/pack0_validation.json" \
              --trace "$TRACE"
          fi

      - name: Criar ZIP final
        run: |
          cd _outputs
          zip -r ../factory_outputs.zip .
          cd ..

      - uses: actions/upload-artifact@v4
        with:
          name: factory_outputs
          path: factory_outputs.zip
