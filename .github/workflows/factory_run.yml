name: PRODUCAO_DE_FABRICA

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Escolha o que gerar"
        required: true
        default: "pack0"
        type: choice
        options:
          - pack0
          - pack1
      module:
        description: "Nome do modulo (ex: meetcore)"
        required: true
        default: "meetcore"
      trace:
        description: "Identificador"
        required: true
        default: "LAI-RUN"
      blueprint:
        description: "Blueprint (opcional, fica salvo como arquivo, mas o motor nao usa argumento)"
        required: false
        default: ""

jobs:
  gerar:
    runs-on: ubuntu-latest
    steps:
      - name: Baixar codigo do repositorio
        uses: actions/checkout@v4

      - name: Preparar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependencias minimas
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Preparar pastas
        run: |
          mkdir -p _inputs _outputs

      - name: Salvar blueprint (apenas arquivo)
        run: |
          echo "${{ inputs.blueprint }}" > _inputs/blueprint.txt

      - name: Rodar motor (sem --blueprint)
        env:
          MODE: ${{ inputs.mode }}
          MODULE: ${{ inputs.module }}
          TRACE: ${{ inputs.trace }}
        run: |
          cd services/pack-factory
          export PYTHONPATH="$(pwd):$PYTHONPATH"
          python -m app.cli "$MODE" --module "$MODULE" --out "../../_outputs" --trace "$TRACE"

      - name: Criar ZIP
        run: |
          cd _outputs
          zip -r ../factory_outputs.zip .
          cd ..

      - name: Enviar ZIP para download
        uses: actions/upload-artifact@v4
        with:
          name: factory_outputs
          path: factory_outputs.zip
