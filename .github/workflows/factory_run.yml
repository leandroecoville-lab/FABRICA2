name: PRODUCAO_DE_FABRICA

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Escolha o que gerar"
        required: true
        default: "pack0"
        type: choice
        options: [pack0, pack1]
      module:
        description: "Nome do modulo (ex: meetcore)"
        required: true
        default: "meetcore"
      trace:
        description: "Identificador"
        required: true
        default: "LAI-RUN"
      blueprint:
        description: "Blueprint (curto). Se for grande, deixe vazio."
        required: false
        default: ""

jobs:
  gerar:
    runs-on: ubuntu-latest
    steps:
      - name: Baixar codigo do repo
        uses: actions/checkout@v4

      - name: Preparar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Encontrar requirements.txt
        id: req
        run: |
          echo "Procurando requirements.txt..."
          REQ=$(find services -maxdepth 4 -name requirements.txt | head -n 1)
          echo "REQ=$REQ" >> $GITHUB_ENV
          if [ -z "$REQ" ]; then
            echo "NAO_ENCONTREI_REQUIREMENTS"
            find services -maxdepth 4 -type f | head -n 200
            exit 1
          fi
          echo "Achei: $REQ"

      - name: Instalar dependencias do motor
        run: |
          python -m pip install --upgrade pip
          pip install -r "$REQ"

      - name: Preparar pastas
        run: |
          mkdir -p _inputs _outputs

      - name: Salvar blueprint
        run: |
          echo "${{ inputs.blueprint }}" > _inputs/blueprint.txt

      - name: Rodar motor
        env:
          PYTHONPATH: services/pack-factory:.
        run: |
          MODE="${{ inputs.mode }}"
          MODULE="${{ inputs.module }}"
          TRACE="${{ inputs.trace }}"

          if [ "$MODE" = "pack0" ]; then
            python -m app.cli pack0 --module "$MODULE" --out "_outputs" --trace "$TRACE" --blueprint "_inputs/blueprint.txt"
          else
            python -m app.cli pack1 --module "$MODULE" --out "_outputs" --trace "$TRACE" --blueprint "_inputs/blueprint.txt"
          fi

      - name: Criar ZIP
        run: |
          cd _outputs
          zip -r ../factory_outputs.zip .
          cd ..

      - name: Enviar ZIP
        uses: actions/upload-artifact@v4
        with:
          name: factory_outputs
          path: factory_outputs.zip
